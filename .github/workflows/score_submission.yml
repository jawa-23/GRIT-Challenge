name: Evaluate Submission

on:
  pull_request_target:
    paths:
      - 'submissions/**'
      
permissions:
  contents: write

jobs:
  evaluate:
    runs-on: ubuntu-latest

    steps:
      # Checkout trusted code (main branch)
      - uses: actions/checkout@v4
        with:
          ref: main

      # Fetch submission file from the PR
      - name: Fetch submission from PR
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr
          git checkout pr -- submissions/*

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Install dependencies
      - name: Install dependencies
        run: |
          pip install pandas pyarrow scikit-learn numpy

      # Clone private test labels repo
      - name: Clone private labels repo
        env:
          EVAL_TOKEN: ${{ secrets.EVAL_TOKEN }}   # PAT with read access to private repo
        run: |
          git clone https://${EVAL_TOKEN}@github.com/jawa-23/GRIT-Secrets.git private

      # Run scoring
      - name: Run scoring
        run: |
          python competition/evaluate.py submissions/* private/test_labels.parquet
          

      # after scoring
      - name: Read score
        id: get_score
        run: echo "SCORE=$(cat score.txt)" >> $GITHUB_OUTPUT
      
      - name: Update leaderboard CSV
        run: python leaderboard/update_leaderboard_csv.py
        env:
          SUBMITTER: ${{ github.event.pull_request.user.login }}
          SCORE: ${{ steps.get_score.outputs.SCORE }}


      # Update leaderboard CSV
      - name: Update leaderboard CSV
        run: python leaderboard/update_leaderboard_csv.py
        env:
          SUBMITTER: ${{ github.event.pull_request.user.login }}
          SCORE: $(python -c "import competition.evaluate; print(competition.evaluate.last_score)")

      # Commit and push leaderboard CSV
      - name: Commit leaderboard CSV
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}   # PAT with push access to repo
        run: |
          git config user.name "challenge-bot"
          git config user.email "challenge-bot@users.noreply.github.com"
          git add leaderboard/leaderboard.csv
          git commit -m "Update leaderboard"
          git push https://${BOT_TOKEN}@github.com/jawa-23/GRIT-Challenge.git main

      - name: Copy CSV to docs
        run: cp leaderboard/leaderboard.csv docs/leaderboard.csv
